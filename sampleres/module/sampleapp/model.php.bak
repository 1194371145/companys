<?php
/**
 * The control file of project module of ZenTaoPMS.
 *
 * @copyright   Copyright 2009-2012(QingDao Nature Easy Soft Network Technology Co,LTD www.cnezsoft.com)
 * @author      Chunsheng Wang <chunsheng@cnezsoft.com>
 * @package     project
 * @version     $Id: control.php 2657 2012-02-23 01:46:06Z shiyangyangwork@yahoo.cn $
 * @link        http://www.zentao.net
 */
class projectModel extends model
{
    /* The members every linking. */
    const LINK_MEMBERS_ONE_TIME = 20;

    /**
     * Check the privilege. 
     * 
     * @param  object    $project 
     * @access public
     * @return bool
     */
    public function checkPriv($project)
    {
    	
        
		if(trim($this->app->user->account) == trim($project->openby) ) return true;
		
		$faesales = $this->dao->select('fae,sales,region')->from('zt_wgcend')->where('cardcode')->eq(trim($project->end_customer))->fetch();
		if($faesales->fae == trim($this->app->user->account) || $faesales->sales == trim($this->app->user->account)) return true;
		//check pm priv
		$pmname = $this->dao->select('promanager')->from('zt_wgclowprice')->where('partnumber')->eq($project->partnumber)->fetch('promanager');
		
		if(strpos(strtolower($pmname),$this->app->user->account) !== false && $this->app->user->dept == 19) return true;
		//echo $pmname.$this->app->user->dept;exit;
	   //为非实际区域rfq 设置实际区域manager approve
       if($project->region == "strategy" && $this->app->user->account == "frankie") return true;
	   if($project->region == "southchina" && $this->app->user->account == "michael") return true;
	   if($project->region == "northchina" && $this->app->user->account == "henry") return true;
       if($project->region == "taiwan" && $this->app->user->account == "nick") return true;
       if($project->region == "korea" && $this->app->user->account == "joshuah") return true;
       if(strpos('andywang,davidtimm,paulliu',$this->app->user->account) !== false ) return true;

		if(strpos('C000970,C000415,C001811',$project->end_customer) !== false && $this->app->user->account == "harvey") return true;
        /* If is admin, return true. */
        $account = ',' . $this->app->user->account . ',';
        if(strpos($this->app->company->admins, $account) !== false) return true; 
		
        /* If project is open, return true. */
        if($project->acl == 'open') return true;

        /* Get team members. */
        $teamMembers = $this->getTeamMemberPairs($project->id);

        /* If project is private, only members can access. */
        if($project->acl == 'private')
        {
            return isset($teamMembers[$this->app->user->account]);
        }
        if($this->app->user->account == "wangrong" || $this->app->user->account == "shuangjuan" || $this->app->user->account == "liping" || $this->app->user->dept == 14) return true;
        /* Project's acl is custom, check the groups. */
        if($project->acl == 'custom')
        {
			
			
            if(isset($teamMembers[$this->app->user->account])) return true;
            $userGroups    = $this->loadModel('user')->getGroups($this->app->user->account);
            $projectGroups = explode(',', $project->whitelist);
            foreach($userGroups as $groupID)
            {
                if(in_array($groupID, $projectGroups)) return true;
            }
            $openbyGroups = $this->loadModel('user')->getGroupsName($project->openby);
            $userGroup = $this->loadModel('user')->getGroupsName($this->app->user->account);
			if(strpos($userGroup, $openbyGroups) !== false && strpos($userGroup,'manager') !== false) return true;
			
            return false;
        }
    }
    /**
     * Check approve privilege
     * @access public
     * @return bool
     */
    public function checkWgcPriv()
    {
       $project = $this->getById(intval($_GET['projectID']));
       //if(strpos($this->app->company->admins,$this->app->user->account) > 0 ) return true;
       $account = $this->app->user->account;
	   
       if($project->acl != 'custom') return false;
       $userGroups    = $this->loadModel('user')->getGroups($this->app->user->account);
       $address = $this->user->getById($project->requestby);
       $managergroup = $this->lang->project->mgrgroup[$address->address]; 
	   //为非实际区域rfq 设置实际区域manager approve
       if($project->region == "strategy" && $this->app->user->account == "frankie") return true;
	   if($project->region == "southchina" && $this->app->user->account == "michael") return true;
	   if($project->region == "northchina" && $this->app->user->account == "henry") return true;
       if($project->region == "taiwan" && $this->app->user->account == "nick") return true;
       if($project->region == "korea" && $this->app->user->account == "joshuah") return true;
	   if(strpos(',davidtimm,',$this->app->user->account) !== false ) return true;
	   if(strpos('C000970,C000415,C001811',$project->end_customer) !== false && $this->app->user->account == "harvey") return true;
	   
       if(in_array($managergroup,$userGroups))
       {
          return true;
       }
       else 
       {
       	  
          return false;
       }      
    }
    
    //check if need product manager approve 
    public function checkPmPriv()
    {
       $projectID = intval($_GET['projectID']);
       $result = $this->dao->select('signature')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(0)->fetch();
       if(!$result) return false;
       if($result->signature == "reject") return false;
       $partnum = $this->dao->select('partnumber')->from('zt_custom')->where('id')->eq($projectID)->fetch('partnumber');
       $pmname = $this->dao->select('promanager')->from('zt_wgclowprice')->where('partnumber')->eq($partnum)->fetch('promanager');
       
       if($this->app->user->dept == 19 && strpos(strtolower($pmname),$this->app->user->account) !== false)
       {
          return true;
       }
       else 
       {
          return false;
       }
       

       
       return false;
    }    
    
    //check if need ceo approve or not 
    public function checkAdminPriv()
    {
       $projectID = intval($_GET['projectID']);
       $result = $this->dao->select('signature')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(0)->fetch();
       if(!$result) return false;
       if($result->signature == "reject") return false;
           	
       if(strpos($this->app->company->admins.",issac",$this->app->user->account) > 0 )
       {
          return true;
       }
       else 
       {
          return false;
       }

       
       return false;
    }
    
    
    //edit privilege
    public function checkEditPriv()
    {
       $projectID = intval($_GET['projectID']);
       if(strpos(',admin,issac,lynn,',$this->app->user->account) !== false)
       {
          return true;
       }
       
       $result = $this->dao->select('signature')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->fetch();
       if($result) return false;
       $result2 = $this->dao->select('status')->from(WGC_TABLE_CUSTOM)->where('id')->eq($projectID)->fetch();
       if($result2->status != "Pending") return false;
       return true;
    }

    
    
    /**
     * get approve info by projectID
     * @param int $projectID
     * @access public
     * @return array
     */
    public function getApproveInfo($projectID)
    {
       $result = $this->dao->select('*')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('deleted')->eq(0)->fetchAll();
       if(!$result) return array();
       foreach($result as $key => $value)
       {
          $approveinfo[$value->role] = $value;
       }
       return $approveinfo;
    }
    
    /**
     * check the priv has mgr mgr
     */
    public function checkAdminGroup()
    {
        /* if is admin group return true */
        $admingroup = $this->dao->select('account')->from(TABLE_USERGROUP)->where('`group`')->eq(1)->fetchAll();
        if(isset($admingroup))
        {
           foreach($admingroup as $value)
           {
           	  $arradmingroups[] = $value->account;  
           }
           $admingroup = implode(',',$arradmingroups);
           if(strpos($admingroup,$this->app->user->account) !== false)
           {
              return true;
           }
           else 
           {
              return false;
           }
        }
        else
        {
           return false;
        }
    
    }
    /**
     * Set menu.
     * 
     * @param  array  $projects 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function setMenu($projects, $projectID)
    {
    	
        /* Check the privilege. */
        if($projects and !isset($projects[$projectID]) and !$this->checkPriv($this->getById($projectID)))
        {
            echo(js::alert($this->lang->project->accessDenied));
            die(js::locate('back'));
        }

        $moduleName = $this->app->getModuleName();
        $methodName = $this->app->getMethodName();
        //$selectHtml = $this->select($projects, $projectID, $moduleName, $methodName);
        //foreach($this->lang->project->menu as $key => $menu)
        //{
         //   $replace = $key == 'list' ? $selectHtml . $this->lang->arrow : $projectID;
         //   common::setMenuVars($this->lang->project->menu, $key,  $replace);
        //}
    }

    /**
     * Create the select code of projects. 
     * 
     * @param  array     $projects 
     * @param  int       $projectID 
     * @param  string    $currentModule 
     * @param  string    $currentMethod 
     * @access public
     * @return string
     */
    public function select($projects, $projectID, $currentModule, $currentMethod)
    {
        /* See product's model method:select. */
        $switchCode  = "switchProject($('#projectID').val(), '$currentModule', 'view');";
        $onchange    = "onchange=\"$switchCode\""; 
        $onkeypress  = "onkeypress=\"eventKeyCode=event.keyCode; if(eventKeyCode == 13) $switchCode\""; 
        $onclick     = "onclick=\"eventKeyCode = 13; $switchCode\""; 
        $selectHtml  = html::select('projectID', $projects, $projectID, "tabindex=2 $onchange $onkeypress");
        $selectHtml .= html::commonButton($this->lang->go, "id='projectSwitcher' tabindex=3 $onclick");
        return $selectHtml;
    }

    /**
     * Save the project id user last visited to session.
     * 
     * @param  int   $projectID 
     * @param  array $projects 
     * @access public
     * @return int
     */
    public function saveState($projectID, $projects)
    {
        if($projectID > 0) $this->session->set('project', (int)$projectID);
        if($projectID == 0 and $this->cookie->lastProject)    $this->session->set('project', (int)$this->cookie->lastProject);
        if($projectID == 0 and $this->session->project == '') $this->session->set('project', $projects[0]);
        if(!in_array($this->session->project, $projects)) $this->session->set('project', $projects[0]);
        return $this->session->project;
    }

    /**
     * Save order 
     * 
     * @access public
     * @return void
     */
    public function saveOrder()
    {
        foreach($_POST as $projectID => $order)
        {
            $this->dao->update(WGC_TABLE_CUSTOM)->set('`order`')->eq($order)->where('id')->eq($projectID)->exec();
        }
    }



    /*
     * insert visit note
     */
    public function createnote()
    {
    
    	$note = fixer::input('post')->get();
    	$this->dao->insert(WGC_TABLE_VISITNOTE)->data($note)
    	->batchcheck($this->config->project->createnote->requiredFields,'notempty')->exec();
    	
    }
    
    
    public function create($copyProjectID = '')
    {
    	if(trim($_POST['end_custmp']) != trim($_POST['end_customer']) && strlen($_POST['end_custmp']) > 2 && strlen($_POST['end_customer']) > 2) die(js::error('Two choice end code is not the same ! '));
        $this->lang->project->team = $this->lang->project->teamname;
        $oldrfq = $this->getOldRfq($this->app->user->account,trim($this->post->partnumber),$this->post->distributor,$this->post->end_customer);
        if(strpos($this->config->project->costdown,$this->post->end_customer) !== false && $this->app->user->account != "michael" && $this->app->user->account != "nick" && $this->app->user->account != "frankie" && $this->app->user->account != "joshuah" && $this->app->user->account != "lynn" && $this->app->user->account != "davidtimm")
        {
           $costdown = $this->getoldcostdown($oldrfq,$this->post->price_dis);
           if($costdown > 25 && $oldrfq > 1) die(js::error("Cost down more than 25%,only region manager can create it ."));
        }
		if(trim($_POST['end_custmp']) != trim($_POST['end_customer'])) die(js::error('Two choice of end customer is not the same !'));
		
        $discodeinfo = $this->dao->select('cardname,cardcode')->from('zt_wgcdis')->where('cardcode')->eq($_POST['distributor'])->fetch();
		$discode = $discodeinfo->cardcode."-".$discodeinfo->cardname;
        $project = fixer::input('post')
            ->add('acl',"custom")
            ->add('status','Pending')
            ->add('openby',$this->app->user->account)
            ->add('oldrfq',$oldrfq)
            ->add('requestby',$this->app->user->id)
            ->add('whitelist', implode(',',$this->post->whitelist))
            ->add('createdate',date("Y-m-d"))
			->remove('discode')
			->add('discode',$discode)
            ->get();
		if($this->app->user->account == "issac" || trim($_POST['end_customer']) == "C001811" || $this->app->user->account == "lynn" || $this->app->user->account == "admin")
		{

		}
		else
		{
		   $partmaxin = $this->dao->select('projectname')->from('zt_wgclowprice')
			          ->where('partnumber')->eq(trim($this->app->post->partnumber))
			          ->fetch('projectname');
		   if(strpos($this->app->post->partnumber,'71M') !== false || $partmaxin == "maxin" || strpos($this->app->post->partnumber,'78M') !== false || strpos($this->app->post->partnumber,'MAX') !== false)
			{
		      if(floatval($this->app->post->price_dis)/floatval($this->app->post->price_cus) < 0.75 ) die(js::error('maxim commission must less than or equal to 25%'));
		    }
			elseif($this->app->user->address == "US" || $this->app->user->address == "EU" || $this->app->user->address == "JP")
			{
			   
			}
			else
			{
              if(floatval($this->app->post->price_cus)/floatval($this->app->post->price_dis) > 1.1 && $this->app->user->address == "CN") die(js::error('commission must less than or equal to 10%'));
              if(floatval($this->app->post->price_dis)/floatval($this->app->post->price_cus) < 0.89 && $this->app->user->address != "CN") die(js::error('commission must less than 11%'));  
			}
		}
		if($project->end_customer == $project->distributor)
		{
           $this->dao->insert(WGC_TABLE_CUSTOM)->data($project)
            ->autoCheck($skipFields = 'reason')
            ->batchcheck($this->config->project->create->requiredFieldsnocomm, 'notempty')
            ->checkIF($project->initial_date != '', 'date', 'date')
            ->checkIF($project->price_dis != '', 'price_cus', 'ge', $project->price_dis)
			//->checkIF($project->price_dis != '', 'commission', 'lt', '11')
            ->check('rfqcode', 'unique')
            ->exec();    
		}
		else
		{
	        $this->dao->insert(WGC_TABLE_CUSTOM)->data($project)
            ->autoCheck($skipFields = 'reason')
            ->batchcheck($this->config->project->create->requiredFields, 'notempty')
            ->checkIF($project->initial_date != '', 'date', 'date')
            ->checkIF($project->price_dis != '', 'price_cus', 'ge', $project->price_dis)
			////->checkIF($project->price_dis != '', 'commission', 'lt', '11')
            ->check('rfqcode', 'unique')
            ->exec(); 	   
		}
        $projectID     = $this->dao->lastInsertId();
        /* Add the creater to the team. */
        if(!dao::isError())
        {
            $today         = helper::today();
            $creatorExists = false;
            /* Copy team of project. */
            if($copyProjectID != '') 
            {
                $members = $this->dao->select('*')->from(TABLE_TEAM)->where('project')->eq($copyProjectID)->fetchAll();
                foreach($members as $member)
                {
                    $member->project = $projectID;
                    $member->join    = $today;
                    $this->dao->insert(TABLE_TEAM)->data($member)->exec();
                    if($member->account == $this->app->user->account) $creatorExists = true;
                }
            }

            /* Add the creator to team. */
            if($copyProjectID == '' or !$creatorExists)
            {
                $member->project  = $projectID;
                $member->account  = $this->app->user->account;
                $member->join     = $today;
                $member->days     = $project->days;
                $member->hours    = $this->config->project->defaultWorkhours;
                $this->dao->insert(TABLE_TEAM)->data($member)->exec();
            }
            //customer update fae,sales
            $cusinfo = $this->dao->select('cardcode,fae,sales')->from('zt_wgcend')->where('cardcode')->eq($project->end_customer)->fetch();
            if($cusinfo)
            {
               if(strlen($cusinfo->fae) < 3 ) $data['fae'] = $project->fae;
               if(strlen($cusinfo->sales) < 3 ) $data['sales'] = $project->sales;
               if(strlen($cusinfo->fae) < 3 || strlen($cusinfo->sales) < 3)
               {
                  $this->dao->update('zt_wgcend')->data($data)->where('cardcode')->eq($project->end_customer)->exec();
               }
            }
            else
            {
/*               $data['fae'] = $project->fae;
               $data['fae'] = $project->sales;
               $data['cardcode'] = trim($project->end_customer);
               $this->dao->insert('zt_wgcend')->data($data)->exec();*/
            }
            
            return $projectID;
        } 
    }    
    
    
    /**
     * Update a rfq info .
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function update($projectID)
    {
        $oldProject = $this->getById($projectID);
        $team = $this->getTeamMemberPairs($projectID);
        $this->lang->project->team = $this->lang->project->teamname;
        $projectID = (int)$projectID;
        $project = fixer::input('post')
            ->stripTags('end_customer')
            ->add('whitelist','1,8')
            ->get();
        //print_r($project);exit;
	      $partmaxin = $this->dao->select('projectname')->from('zt_wgclowprice')
			          ->where('partnumber')->eq(trim($this->app->post->partnumber))
			          ->fetch('projectname');
		 if(strpos($this->app->post->partnumber,'71M') !== false || $partmaxin == "maxin")
		{
		      if(floatval($this->app->post->price_dis)/floatval($this->app->post->price_cus) < 0.75 ) die(js::error('maxim commission must less than or equal to 25%'));
		}
        elseif($this->app->user->address == "US" || $this->app->user->address == "EU" || $this->app->user->address == "JP")
		{
			   
		}
		else
		{

         if(floatval($this->app->post->price_cus)/floatval($this->app->post->price_dis) > 1.1105 && $this->app->user->account != "admin"  &&   $this->app->user->account != "issac" && ($this->app->user->address == "NCN" || $this->app->user->address == "SCN") ) 
		 {
			die(js::error('commission must less than or equal to 10%'));
		 }
          if(floatval($this->app->post->price_dis)/floatval($this->app->post->price_cus) < 0.89 && $this->app->user->account != "admin" &&  $this->app->user->account != "issac" && strpos($this->app->user->address,'CN') === false)
		  {
			die(js::error('commission must less than 11%'));
		  }  
		}
		//limit repeat rfq# and usage
		$existid = $this->dao->select('id')->from(WGC_TABLE_CUSTOM)
			      ->where('rfqcode')->eq(trim($this->app->post->rfqcode))
			      ->andWhere('`usage`')->like(trim($this->app->post->usage))
			      ->andWhere('id')->ne($projectID)
			      ->fetch('id');
		if($existid > 0) die(js::alert("RFQ code [".$this->app->post->rfqcode."] and quantity [".$this->app->post->usage."] has already exist!"));
		if($project->end_customer == $project->distributor)
		{
            $this->dao->update(WGC_TABLE_CUSTOM)->data($project)
            ->batchcheck($this->config->project->edit->requiredFieldsnocomm, 'notempty')          
            //->check('rfqcode', 'unique', "id!=$projectID ")
            ->where('id')->eq($projectID)
            ->limit(1)
            ->exec();
		}
		else
		{
		    $this->dao->update(WGC_TABLE_CUSTOM)->data($project)
            ->batchcheck($this->config->project->edit->requiredFields, 'notempty')          
            //->check('rfqcode', 'unique', "id!=$projectID")
            ->where('id')->eq($projectID)
            ->limit(1)
            ->exec();

		}
           

       

        
        if(!dao::isError()) return common::createChanges($oldProject, $project);
    }
    /*
     * cancel rfq
     * @param int $projectID
     * @return bool
     */
    public function cancelrfq($projectID)
    {
       
       $res = $this->dao->update(WGC_TABLE_CUSTOM)->set('status')->eq('cancel')->where('id')->eq($projectID)->exec();
       if($res) return true;
       return false;
    }
    /**
     * Update approve info 
     * @access public
     * @return array
     */
    public function updateApprove($projectID=0)
    {
       $projectID = intval($projectID);
       $oldapproinfo = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)->where('id')->eq($projectID)->fetch(); 
       $rfqinfo = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)->where('id')->eq($projectID)->fetch();
       if($this->app->user->account == "michael") 
       {
          if(strpos($this->lang->project->chenwei,$oldapproinfo->openby) !== false && $oldapproinfo->openby != "david" && $oldapproinfo->openby != "jim")
		   {
		        //echo js::error("You can not approve this rfq !");
                //exit;
		   }

       }  		
       if($oldapproinfo->status == "Cancel")
       { 
          echo js::error("Cancelled quotation cannot be modified"); 
          exit;
       } 
       //update mgrprice     
       if(isset($_POST['mgrprice']) || isset($_POST['mgrcomment']) || isset($_POST['mgrsignature']))
       {
       	  if($_POST['mgrprice'] < $oldapproinfo->price_dis) die(js::error("Price can not lower than {$oldapproinfo->price_dis}"));
       	  $oldapproinfo = $this->dao->select('*')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(0)->fetch();
       	  if(isset($_POST['mgrprice']) && trim($_POST['mgrsignature']) != "reject") 
       	  {
       	    if(!is_numeric($_POST['mgrprice']) || $_POST['mgrprice'] < 0)
       	  	{
       	  	 echo js::error("Please input numeric !");
       	  	 exit;
       	  	}
       	  }
          $mgrdata = array('cid'=>$projectID,'role'=>0,'signdate'=>helper::today(),'comment'=>$oldapproinfo->comment,'signature'=>$oldapproinfo->signature);
		  $mgrdata['price'] = $oldapproinfo->price;
          $mgrdata['comment'] = $oldapproinfo->comment;
          $mgrdata['signature'] = $oldapproinfo->signature;
          if(trim($this->post->mgrprice) != "") $mgrdata['price'] = trim($this->post->mgrprice);
          if(trim($this->post->mgrcomment) != "") $mgrdata['comment'] = trim($this->post->mgrcomment);
          if(trim($this->post->mgrsignature) != "") $mgrdata['signature'] = trim($this->post->mgrsignature);          
          
          $this->dao->replace(WGC_TABLE_APPROVE)->data($mgrdata)->exec();
          if(trim($_POST['mgrsignature']) == "reject")
          {
             $this->dao->update(WGC_TABLE_APPROVE)->data(array('signature'=>"reject"))->where('cid')->eq($projectID)->andWhere('role')->eq(4)->exec();
          }
          $this->updateStatus($projectID);
          if(!dao::isError()) return common::createChanges($oldapproinfo, $mgrdata);
          
       }
       //update pmprice     
       if(isset($_POST['pmprice']) || isset($_POST['pmcomment']) || isset($_POST['pmsignature']))
       {
       	  //add limit pm price > sales dis price and cm price
       	  $cmprice = $this->dao->select('price')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(0)->fetch('price');
       	  if($_POST['pmprice'] < $rfqinfo->price_dis || $_POST['pmprice'] < $cmprice) die(js::error("Price can not lower than {$cmprice}"));
       	  $oldapproinfo = $this->dao->select('*')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(1)->fetch();
       	  if(isset($_POST['pmprice']) && trim($_POST['pmsignature']) != "reject") 
       	  {
       	    if(!is_numeric($_POST['pmprice']) || $_POST['pmprice'] < 0)
       	  	{
       	  	 echo js::error("Please input numeric for price !");
       	  	 exit;
       	  	}
       	  }
          $pmdata = array('cid'=>$projectID,'role'=>1,'signdate'=>helper::today(),'comment'=>$oldapproinfo->comment,'signature'=>$oldapproinfo->signature);
		  $pmdata['price'] = $oldapproinfo->price;
          $pmdata['comment'] = $oldapproinfo->comment;
          $pmdata['signature'] = $oldapproinfo->signature;
          if(trim($this->post->pmprice) != "") $pmdata['price'] = trim($this->post->pmprice);
          if(trim($this->post->pmcomment) != "") $pmdata['comment'] = trim($this->post->pmcomment);
          if(trim($this->post->pmsignature) != "") $pmdata['signature'] = trim($this->post->pmsignature);          
          
          $this->dao->replace(WGC_TABLE_APPROVE)->data($pmdata)->exec();
          if(trim($_POST['pmsignature']) == "reject")
          {
             $this->dao->update(WGC_TABLE_APPROVE)->data(array('signature'=>"reject"))->where('cid')->eq($projectID)->andWhere('role')->eq(4)->exec();
          }
          $this->updateStatus($projectID);
          if(!dao::isError()) return common::createChanges($oldapproinfo, $pmdata);
          
       }       
       
       //update ceo price
       if(isset($_POST['ceoprice']) || isset($_POST['ceocomment']) || isset($_POST['ceosignature']))
       {
       	  $oldapproinfo = $this->dao->select('*')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->andWhere('role')->eq(4)->fetch();
       	  if(isset($_POST['ceoprice']) )
       	  { 
       	  	if(!is_numeric($_POST['ceoprice']) || $_POST['ceoprice'] < 0)
       	  	{
       	  	 echo js::error("Please input numeric !");
       	  	 exit;
       	  	}
       	  }
          $mgrdata = array('cid'=>$projectID,'role'=>4,'signdate'=>helper::today(),'comment'=>$oldapproinfo->comment,'signature'=>$oldapproinfo->signature);
		  $mgrdata['price'] = $oldapproinfo->price;
          $mgrdata['comment'] = $oldapproinfo->comment;
          $mgrdata['signature'] = $oldapproinfo->signature;
          if(trim($this->post->ceoprice) != "") $mgrdata['price'] = trim($this->post->ceoprice);
          if(trim($this->post->ceocomment) != "") $mgrdata['comment'] = trim($this->post->ceocomment);
          if(trim($this->post->ceosignature) != "") $mgrdata['signature'] = trim($this->post->ceosignature);
          $this->dao->replace(WGC_TABLE_APPROVE)->data($mgrdata)->exec();
          $this->updateStatus($projectID);
          if(!dao::isError()) return common::createChanges($oldapproinfo, $mgrdata);
       } 
         

    }
    
    /**
     * update request quotation status and active by approve info
     * @param int $projectID
     * @access public
     * @return void
     */
    public function updateStatus($projectID = 0)
    {
       $projectinfo = $this->getById($projectID);
       $statusinfo = $this->dao->select('role,signature')->from(WGC_TABLE_APPROVE)->where('cid')->eq($projectID)->fetchAll();
       $lowprice = $this->dao->select('partnumber,pmprice,mgrprice,ceoprice')
                             ->from(WGC_TABLE_LOWPRICE)
                             ->where('partnumber')->eq(strtoupper(trim($projectinfo->partnumber)))
                             ->andWhere('mgrprice')->gt(0)
                             ->fetch();
       if(!isset($statusinfo))
       { 
       	   $statusstr = "Pending";
       }
       else
       {
          foreach($statusinfo as $key => $value)
          {
             $tmp[$value->role] = $value->signature;
          }
       if(!$lowprice)
       {
          if($tmp[0] == "approve" && ($tmp[4] == "reject" || $tmp[1] == "reject"))
          {
             $statusstr = "Reject";
          }
          elseif(($tmp[0] == "approve" || $tmp[1] == "approve") && $tmp[4] != "reject" &&  $tmp[4] != "approve")
          {
             $statusstr = "Pending";
          }         
          elseif( (!isset($tmp[0]) || !isset($tmp[1]) ) && $tmp[4] == "reject")
          {
             $statusstr = "Reject";
          }
          elseif(($tmp[0] == "reject" || $tmp[1] == "reject") && $tmp[4] != "approve")
          {
             $statusstr = "Reject";
          }
          elseif($tmp[4] == "approve")
          {
             $statusstr = "Approved";
          }
		  elseif($tmp[4] == "reject")
		  {
		     $statusstr = "Reject";
		  }
          else 
          {
             $statusstr = "Pending";
          }
       }
       else
       {
          $lowmgrprice = $lowprice->mgrprice;
          $lowpmprice = $lowprice->pmprice;
          $lowceoprice = $lowprice->ceoprice;
          if($tmp[0] == "approve" && $this->post->mgrprice >= $lowmgrprice && $lowmgrprice > 0 && $tmp[4] != "reject" && $tmp[1] != "reject")
          {
             $statusstr = "Approved";
          }
          elseif($tmp[1] == "approve" && $this->post->pmprice >= $lowpmprice && $lowpmprice > 0 && $tmp[4] != "reject")
          {
             $statusstr = "Approved";
          }          
          elseif($tmp[0] == "approve" && $this->post->mgrprice < $lowmgrprice && $tmp[4] != "reject" &&  $tmp[4] != "approve" && $tmp[1] != "reject")
          {
             $statusstr = "Pending";
          }  
          elseif($tmp[1] == "approve" && $this->post->pmprice < $lowpmprice && $tmp[4] != "reject" &&  $tmp[4] != "approve")
          {
             $statusstr = "Pending";
          }                  
          elseif( ($tmp[0] == "reject" || $tmp[1] == "reject" ) && $tmp[4] != "approve")
          {
             $statusstr = "Reject";
          }
		  elseif($tmp[4] == "approve")
          {
             $statusstr = "Approved";
          }
		  elseif($tmp[4] == "reject")
		  {
		     $statusstr = "Reject";
		  }
          else 
          {
             $statusstr = "Pending";
          }
          
       }

       }
       $updatedate = array('status'=>trim($statusstr));
	   //die(js::alert($statusstr.$tmp[4]));
       if($statusstr == "Approved" && ($this->post->ceoprice > 0 || $this->post->mgrprice > 0 || $this->post->pmprice > 0))
       {
       	  if($this->post->ceoprice > 0)
       	  {
             $updatedate['price_dis'] = $this->post->ceoprice;
			 
			 //if($projectinfo->region == "china")
			 if(strpos($projectinfo->region,"china") !== false)
             {
                $updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->ceoprice)*100/$this->post->ceoprice);
             }
             else 
             {
                $updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->ceoprice)*100/$projectinfo->price_cus);
             }
          
       	  }
       	  elseif($this->post->pmprice > 0)
       	  {
       	  	$updatedate['price_dis'] = $this->post->pmprice;
       	  	if(strpos($projectinfo->region,"china") !== false)
       	  	{
       	  		$updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->pmprice)*100/$this->post->pmprice);
       	  	}
       	  	else
       	  	{
       	  		$updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->pmprice)*100/$projectinfo->price_cus);
       	  	}
       	  }
       	  else
       	  {
       	     $updatedate['price_dis'] = $this->post->mgrprice;
       	     if(strpos($projectinfo->region,"china") !== false)
             {
             	$updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->mgrprice)*100/$this->post->mgrprice);
             }
             else
             {
             	$updatedate['commission'] = sprintf('%.2f',($projectinfo->price_cus - $this->post->mgrprice)*100/$projectinfo->price_cus);
             }
       	  }
       }
       //update custom price_dis
       $this->dao->update(WGC_TABLE_CUSTOM)->data($updatedate)->where('id')->eq($projectID)->exec();
       $ceochanges = common::createChanges($projectinfo, $updatedate);
       if($ceochanges)      
       {
           $actionID = $this->loadModel('action')->create('wgcproject', $projectID, 'edited');
           $this->action->logHistory($actionID, $ceochanges);          
       }     
       if($statusstr == "Approved")
       {
       	 $projectinfo = $this->getById($projectID);
   	      //update cancel old rfq     	  
          $this->dao->update(WGC_TABLE_CUSTOM)->data(array('status'=>'Invalid'))
                    ->where('status')->eq('Approved')
                    ->andWhere('openby')->eq($projectinfo->openby)
                    ->andWhere('partnumber')->eq($projectinfo->partnumber)
                    ->andWhere('distributor')->eq($projectinfo->distributor)
                    ->andWhere('end_customer')->eq($projectinfo->end_customer)
                    ->andWhere('`date`')->lt($projectinfo->date)
                    ->exec();
         $this->dao->update('zt_wgcend')->data(array('fae'=>$projectinfo->fae,'sales'=>$projectinfo->sales))->where('cardcode')->eq(trim($projectinfo->end_customer))->exec();
         //save quotation info to SBO by DI API
         
		 //$this->saveQuotationToSBO($projectinfo,"old_SLGKM01");
		
		 $this->saveQuotationToSBO($projectinfo,"SLGHZ05");
         $this->saveQuotationToSBO($projectinfo,"SLGKM01");
         $this->saveQuotationToSBO($projectinfo,"SLGNJ06");
         
       }
    }
    
    
    /*
     * save quotation info to SBO by DI API
     * @param str $DB
     * @return int  
     */
    public function saveQuotationToSBO($projectinfo,$DB = 'SLGKM02')
    {
         $mycomp = $this->dao->connectToSBO($DB);
         if($mycomp->Connect == 0)
         {         
         	$vitem = $mycomp->GetBusinessObject(4);
         	$vdis  = $mycomp->GetBusinessObject(2);
         	if($vitem->GetByKey($projectinfo->partnumber) == true && $vdis->GetByKey($projectinfo->distributor) == true && $vdis->GetByKey($projectinfo->end_customer) == true)
         	{
         		$duedate = date("Y/m/d",strtotime($projectinfo->date)+3600*24*intval($projectinfo->validperiod));
         		$vatgroup = "X0";
         		if($DB  == "SLGKM01") $vatgroup = "X0";
         		if($DB  == "SLGHZ05" || $DB  == "SLGNJ06") $vatgroup = "X0";
         		$oQuotations = $mycomp->GetBusinessObject(23);
         		$oQuotations->CardCode = strval($projectinfo->distributor);
         		$oQuotations->DocDueDate = strval($duedate);//"2013/10/10"
         		$oQuotations->UserFields->Fields->Item("U_Ccode")->Value = trim($projectinfo->end_customer);//C001014
         		$oQuotations->UserFields->Fields->Item("U_Sprice")->Value = $projectinfo->price_cus;
         		$oQuotations->UserFields->Fields->Item("U_PONum")->Value = $projectinfo->id;
         		$oQuotations->Lines->Itemcode = trim($projectinfo->partnumber);//SY7208ABC
         		$oQuotations->Lines->Price = $projectinfo->price_dis;
         		$oQuotations->Lines->Currency = "USD";
         		$oQuotations->Lines->VatGroup = $vatgroup;
         		$oQuotations->Lines->Quantity = 999999999;
         		
         		$result = $oQuotations->Add();
         		//update customer lines
         		 $oRS2 = $mycomp->GetBusinessObject(300);
         		 $oRS2->DoQuery("SELECT top 1 docentry from OQUT where  U_PONum = ".intval($projectinfo->id)." order by docentry desc");
         		 $oRS2->MoveFirst;
         		 $docentry = intval($oRS2->Fields('docentry')->value);
         		 $oRS2->DoQuery("update QUT1 set U_Ccode = '".trim($projectinfo->end_customer)."' where docentry = $docentry and linenum = 0"); 
         		 if($result != 0)
         		 {
         		 $this->dao->update('zt_custom')->data(array('sbo'=>'0'))->where('id')->eq($projectinfo->id)->exec();
         		 $a=0;
         		 $b="000";
         		 $mycomp->GetLastError($a,$b);
				 //$mycomp->Disconnect();
         		 $errordata = array('sboerror'=>str_replace('"','',str_replace('','',$b)));
         		 $this->dao->update(WGC_TABLE_CUSTOM)->data($errordata)->where('id')->eq($projectinfo->id)->exec();
                 echo js::alert($DB."generate ERP Price list failed ".$result.$b);
         		 }
         		 else 
         		 {
         		 	$this->dao->update('zt_custom')->data(array('sbo'=>'1','sboerror'=>' '))->where('id')->eq($projectinfo->id)->exec();
         		    echo js::alert($DB."generate ERP Price list success ");
					
         		 }
         		 

         		//$mycomp->Disconnect();
                 
         		//return $result;
         	}
         }
         
    
         
    }
    
    /**
     * Update a project by no post.
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function updatedata($projectID,$data)
    {
        $oldProject = $this->getById($projectID);
        $team = $this->getTeamMemberPairs($projectID);
        $this->lang->project->team = $this->lang->project->teamname;
        $projectID = (int)$projectID;

              
        $this->dao->update(WGC_TABLE_CUSTOM)->data($data)
            ->autoCheck($skipFields = 'initial_date')
            ->batchcheck($this->config->project->edit->requiredFields, 'notempty')           
            ->check('project_tracking_num', 'unique', "id!=$projectID")
            ->where('id')->eq($projectID)
            ->limit(1)
            ->exec();
           

        

        
        if(!dao::isError()) return common::createChanges($oldProject, $data);
    }
    
 
    /**
     * Get project pairs.
     * 
     * @param  string $mode     all|noclosed or empty 
     * @access public
     * @return array
     */
    public function getPairs($mode = '')
    {
        $orderBy  = !empty($this->config->project->orderBy) ? $this->config->project->orderBy : 'id, `order`, status';
        $mode    .= $this->cookie->projectMode;
        /* Order by status's content whether or not done */
        $projects = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
            ->Where('deleted')->eq(0)
            ->orderBy('date desc')
            ->limit('0,10')
            ->fetchAll();
        $pairs = array();
        foreach($projects as $project)
        {
            //if(strpos($mode, 'noclosed') !== false and $project->status == 'done') continue;
            if($this->checkPriv($project))
            {
                if(strpos($mode, 'nocode') === false and $project->rfqcode)
                {
                    $firstChar = strtoupper(substr($project->rfqcode, 0, 1));
                    if(ord($firstChar) < 127) $project->rfqcode =  $firstChar . ':' . $project->rfqcode;
                }
                $pairs[$project->id] = $project->rfqcode;
            }
        }

        /* If the pairs is empty, to make sure there's an project in the pairs. */
        if(empty($pairs) and isset($projects[0]) and $this->checkPriv($projects[0]))
        {
            $firstProject = $projects[0];
            $pairs[$firstProject->id] = $firstProject->name;
        }
        return $pairs;
    }

    /**
     * Get project lists.
     * 
     * @param  string $status  all|undone|wait|running
     * @param  int    $limit 
     * @access public
     * @return array
     */
    public function getList($status = 'all', $limit = 0, $productID = 0)
    {
        if($productID != 0)
        {
            $result = $this->dao->select('t2.*')
                ->from(TABLE_PROJECTPRODUCT)->alias('t1')
                ->leftJoin(WGC_TABLE_CUSTOM)->alias('t2')
                ->on('t1.project = t2.id')
                ->where('t1.product')->eq($productID)
                ->andWhere('t2.deleted')->eq(0)
                ->orderBy('`order`')
                ->beginIF($limit)->limit($limit)->fi()
                ->fetchAll('id');
        }
        else
        {
            $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)->where('deleted')->eq(0)
                //->beginIF($status != 'all' and $status != 'undone')->andWhere('status')->in($status)->fi()
                ->orderBy('`order`,id')
                ->beginIF($limit)->limit($limit)->fi()
                ->fetchAll('id');
        }
        foreach($result as $key => $value)
        {
           if(!$this->checkPriv($value))
           {
              unset($result[$key]);
           }
        }
        return $result;
    }



    
    /**
     * Get projects lists grouped by product.
     * 
     * @access public
     * @return array
     */
    public function getProductGroupList()
    {
        $list = $this->dao->select('t1.id, t1.name, t2.product')->from(TABLE_PROJECT)->alias('t1')
            ->leftJoin(TABLE_PROJECTPRODUCT)->alias('t2')->on('t1.id = t2.project')
            ->where('t1.deleted')->eq(0)
            ->orderBy('t1.id')
            ->fetchGroup('product');

        foreach($list as $id => $product)
        {
            foreach($product as $ID => $project)
            {
                if(!$this->checkPriv($this->getById($project->id))) 
                {
                    unset($list[$id][$ID]);
                }
            }
        }

        return $list;
    }

    
    /*
     * get project & revision info 
     * @param str $status
     * @access public
     * @return array
     */
    public function getProjectStatsAll($status = 'undone',$projectID = 0)
    {


    	
        $this->loadModel('report');
        $limit = 20;
        $projects =  $this->dao->select('*, IF(INSTR(" done", status) < 2, 0, 1) AS isDone')->from(WGC_TABLE_PROJECT)->where('deleted')->eq(0)
                ->beginIF($status == 'undone')->andWhere('status')->ne('done')->fi()
                ->beginIF($status != 'all' and $status != 'undone')->andWhere('status')->in($status)->fi()
                ->orderBy('id desc')//$this->config->project->orderBy
                ->beginIF($limit)->limit($limit)->fi()
                ->fetchAll('id');
        $stats    = array();
        

        //print_r($projects);
        /* Get total estimate, consumed and left hours of project. */
        $emptyHour = (object)array('totalEstimate' => 0, 'totalConsumed' => 0, 'totalLeft' => 0, 'progress' => 0);       
        foreach($projects as $keyp => $value)
        {
           $tmpproject = $projects[$keyp];
           $tmpproject->maxrevision = $this->loadModel('dept')->getMaxrevision($keyp);
           for($i = 0; $i< $tmpproject->maxrevision+1; $i++)
           {
            $hours[$keyp][$i] = $this->dao->select('project, SUM(estimate) AS totalEstimate, SUM(consumed) AS totalConsumed')
            ->from(WGC_TABLE_SIGNOFF)
            ->where('project')->eq($keyp)
            ->andWhere('revision')->eq($i)
            ->andWhere('deleted')->eq(0)
            ->groupBy('project')
            ->fetch();  
            
            $lefts[$keyp][$i] = $this->dao->select('project, SUM(`left`) AS totalLeft')
            ->from(WGC_TABLE_SIGNOFF)
            ->where('project')->in(array_keys($projects))
            ->andWhere('revision')->eq($i)
            ->andWhere('deleted')->eq(0)
            ->groupBy('project')
            ->fetch();

               $hours[$keyp][$i]->totalLeft = $lefts[$keyp][$i]->totalLeft;
               $hours[$keyp][$i]->totalEstimate = round($hours[$keyp][$i]->totalEstimate,1);
               $hours[$keyp][$i]->totalConsumed = round($hours[$keyp][$i]->totalConsumed,1);
               $hours[$keyp][$i]->totalLeft = isset($hours[$keyp][$i]->totalLeft) ? round($hours[$keyp][$i]->totalLeft, 1) : $emptyHour->totalLeft;
               $hours[$keyp][$i]->totalReal     = $hours[$keyp][$i]->totalConsumed + $hours[$keyp][$i]->totalLeft;
               $hours[$keyp][$i]->progress      = $hours[$keyp][$i]->totalReal ? round($hours[$keyp][$i]->totalConsumed / $hours[$keyp][$i]->totalReal, 3) * 100 : 0;
               
               $hours[$keyp][$i]->definition  = $this->getStepInfoByArr($keyp, array(9,10,11),$i);
               $hours[$keyp][$i]->icdesign  = $this->getStepInfoByArr($keyp, array(12,13,40,39,41,15,16),$i);
               $hours[$keyp][$i]->iclayout  = $this->getStepInfoByArr($keyp, array(17,18,19,42,20),$i);
               $hours[$keyp][$i]->manufacturing  = $this->getStepInfoByArr($keyp, array(21,22,36),$i);
               $hours[$keyp][$i]->acburnin  = $this->getStepInfoByArr($keyp, array(27),$i);
               $hours[$keyp][$i]->tapeout  = $this->getStepInfoByArr($keyp, array(24,25,26,43),$i);
               $hours[$keyp][$i]->aedebug  = $this->getStepInfoByArr($keyp, array(28,29),$i);
               $hours[$keyp][$i]->dedebug  = $this->getStepInfoByArr($keyp, array(30,31,32),$i);
               $hours[$keyp][$i]->tedebug  = $this->getStepInfoByArr($keyp, array(33),$i);
               //get post step info
               if(isset($_POST['wgcstage']))
               {
    	          $wgcstage = $_POST['wgcstage'];
    	          foreach($wgcstage as $stage)
    	          {
    	             if(isset($hours[$keyp][$i]->$stage) && $hours[$keyp][$i]->$stage != "yes") unset($hours[$keyp][$i]);
    	          }
               }
    	       
               $burns[$keyp][$i] = $this->getBurnData($keyp,$i);
               foreach($burns[$keyp][$i] as $data2) $mm[$keyp][$i][] = $data2->value; 
              // print_r($mm);    
               $tmpproject->burns = $mm[$keyp];
               $stepstr[$keyp][$i] = $this->getEveryStepInfo($keyp, $i);
               //get post schedule info
               if(isset($_POST['schedule']))
               {
               	   if(trim($_POST['schedule']) == "beforehand" && $stepstr[$keyp][$i]['schedule'] <= 0) unset($hours[$keyp][$i]);
               	   if(trim($_POST['schedule']) == "delay" && $stepstr[$keyp][$i]['schedule'] >= 0) unset($hours[$keyp][$i]);
               }
               $tmpproject->everystep = $stepstr[$keyp];
               
               unset($stepstr[$i]);
               unset($mm[$i]);  
           } 
        
          unset($i);
        }
        /* Process projects. */
        foreach($projects as $key => $project)
        {
            if($this->checkPriv($project) || $this->checkAdminGroup())
            {
                // Process the end time.
                //$project->end = date(DT_DATE4, strtotime($project->end));
                /* Process the burns. */
                //$project->burns = array();
                $stats[] = $project;
                /* Process the hours. */
                $project->hours = isset($hours[$project->id]) ? $hours[$project->id] : $emptyHour;

            }
            else
            {
                unset($projects[$key]);
                
            }
        }
        //print_r($stats);
        return $stats;
        
    }
    /*
     * get step info 
     * @param int $projectID,
     * @param array $step
     * @param int $revision
     * @access public
     * @return string
     */
    public function getStepInfoByArr($projectID,$step,$revision = 0)
    {
       if(count($step) < 1) return "no";
       $steparr = array();
       //get all must stepitem
       $stepitem = $this->dao->select('step')->from(WGC_TABLE_SIGNITEM)
                 ->where('project')->eq($projectID)
                 ->andWhere('revision')->eq($revision)
                 ->andWhere('muststep')->eq(1)
                 ->fetchAll();
       foreach($step as $value)
       {
          foreach($stepitem as $item)
          {
             if($value == $item->step) $steparr[] = $value;
          }
       }
       if(count($steparr) < 1) return "yes";
       $lastyes = 1;
       foreach($steparr as $value2)
       {
         $yes = $this->loadModel('dept')->getStepOk($projectID,$value2,$revision);
         $lastyes = $lastyes*$yes;
       }       
       return $lastyes == 1 ? "yes" : "no";
    }
    /*get phase and schedule info */
    public function getEveryStepInfo($projectID,$revision)
    {
       
       if($phase == "P1" || $phase == "P2" || $phase == "P3" || $phase == "P4")
       {
          $phase = substr($phase,1,1);
       }
       else
       {
          $phase = 0;
       }
       $revisioninfo['phase'] = $phase;
       $revisioninfo['schedule'] = 0;
       //get schedule info
       $stepitem = $this->dao->select('project,step')->from(WGC_TABLE_SIGNITEM)
                 ->where('project')->eq($projectID)
                 ->andWhere('revision')->eq($revision)
                 ->andWhere('muststep')->eq(1)
                 ->fetchAll();
       if(isset($stepitem))
       {
          $steparr = array();
          foreach($stepitem as $item)
          {
             $stepstatus = $this->dept->getStepOk($projectID,$item->step,$revision);
             if($stepstatus == 1) $steparr[] = $item->step;
          }
          if(count($steparr) > 0)
          {
          	$schedule = $this->dao->select('SUM(consumed) AS totalconsumed,SUM(estimate) AS totalestimate')->from(WGC_TABLE_SIGNOFF)
          	            ->where('project')->eq($projectID)->andWhere('revision')->eq($revision)->andWhere('step')->in(implode(',',$steparr))
          	            ->groupBy('project')
          	            ->fetch();
          	if(isset($schedule->totalconsumed))
          	{
          	   $scheduleall = $schedule->totalestimate - $schedule->totalconsumed;
          	   $revisioninfo['schedule'] = $scheduleall;
          	}           
          }
       }
       return $revisioninfo;
    }
    /**
     * Get project by id.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function getById($projectID)
    {
        $project = $this->dao->findById((int)$projectID)->from(WGC_TABLE_CUSTOM)->fetch();
        if(!$project) return false;
        return $project;
    }
   public function dataExists($data)
   {
      $exists_p = $this->dao->select('id')->from(WGC_TABLE_CUSTOM)
                ->where('customer_name')->eq($data['customer_name'])
                ->andWhere('project_name')->eq($data['project_name'])
                ->andWhere('initial_date')->eq($data['initial_date'])
                ->andWhere('silergy_part_num')->eq($data['silergy_part_num'])
                ->andWhere('eau')->eq($data['eau'])
                ->andWhere('BINARY est_price')->eq($data['est_price'])
                ->andWhere('openby')->eq($this->app->user->account)
                ->fetch();
     if(!$exists_p) return 0;
     return $exists_p;
   	
   }
    /*
     * get wafercode by parentid
     * @param int $parent
     * @access public
     * @return str
     */
    public function getWafercodeByParent($parent = 0)
    {
       $waferinfo = $this->dao->select('wafercode')->from(WGC_TABLE_PRODUCT)->where('id')->eq($parent)->fetch();
       if(isset($waferinfo->wafercode)) return $waferinfo->wafercode;
       
    }
    
    /**
     * Get wgcproject by id.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function getwgcById($projectID)
    {
        return $this->dao->findById((int)$projectID)->from(WGC_TABLE_PROJECT)->fetch();
        
    }
    /**
     * Get the default managers for a project from it's related products. 
     * 
     * @param  int    $projectID 
     * @access public
     * @return object
     */
    public function getDefaultManagers($projectID)
    {
        $managers = $this->dao->select('PO,QM,RM')->from(TABLE_PRODUCT)->alias('t1')
            ->leftJoin(TABLE_PROJECTPRODUCT)->alias('t2')->on('t1.id = t2.product')
            ->where('t2.project')->eq($projectID)
            ->fetch();
        if($managers) return $managers;

        $managers->PO = '';
        $managers->QM = '';
        $managers->RM = '';
        return $managers;
    }

    /**
     * Get products of a project.
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function getProducts($projectID)
    {
        return $this->dao->select('t2.id, t2.name')->from(TABLE_PROJECTPRODUCT)->alias('t1')
            ->leftJoin(TABLE_PRODUCT)->alias('t2')
            ->on('t1.product = t2.id')
            ->where('t1.project')->eq((int)$projectID)
            ->fetchPairs();
    }

    /**
     * Update products of a project.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function updateProducts($projectID)
    {
        $this->dao->delete()->from(TABLE_PROJECTPRODUCT)->where('project')->eq((int)$projectID)->exec();
        if(!isset($_POST['products'])) return;
        $products = array_unique($_POST['products']);
        foreach($products as $productID)
        {
            $data->project = $projectID;
            $data->product = $productID;
            $this->dao->insert(TABLE_PROJECTPRODUCT)->data($data)->exec();
        }
    }

    /**
     * Get related projects 
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function getRelatedProjects($projectID)
    {
        $products = $this->dao->select('product')->from(TABLE_PROJECTPRODUCT)->where('project')->eq((int)$projectID)->fetchAll('product');
        if(!$products) return array();
        $products = array_keys($products);
        return $this->dao->select('t1.id, t1.name')->from(TABLE_PROJECT)->alias('t1')
            ->leftJoin(TABLE_PROJECTPRODUCT)->alias('t2')
            ->on('t1.id = t2.project')
            ->where('t2.product')->in($products)
            ->andWhere('t1.id')->ne((int)$projectID)
            ->andWhere('t1.deleted')->eq(0)
            ->orderBy('t1.id')
            ->fetchPairs();
    }




    /**
     * Get child projects.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function getChildProjects($projectID)
    {
        return $this->dao->select('id, name')->from(TABLE_PROJECT)->where('parent')->eq((int)$projectID)->fetchPairs();
    }

    /**
     * Update childs.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function updateChilds($projectID)
    {
        $sql = "UPDATE " . TABLE_PROJECT . " SET parent = 0 WHERE parent = '$projectID'";
        $this->dbh->exec($sql);
        if(!isset($_POST['childs'])) return;
        $childs = array_unique($_POST['childs']);
        foreach($childs as $childProjectID)
        {
            $sql = "UPDATE " . TABLE_PROJECT . " SET parent = '$projectID' WHERE id = '$childProjectID'";
            $this->dbh->query($sql);
        }
    }

    /**
     * Link story.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function linkStory($projectID)
    {
        if($this->post->stories == false) return false;
        $this->loadModel('action');
        $versions = $this->loadModel('story')->getVersions($this->post->stories);
        foreach($this->post->stories as $key => $storyID)
        {
            $productID = $this->post->products[$key];
            $data->project = $projectID;
            $data->product = $productID;
            $data->story   = $storyID;
            $data->version = $versions[$storyID];
            $this->dao->insert(TABLE_PROJECTSTORY)->data($data)->exec();
            $this->story->setStage($storyID);
            $this->action->create('story', $storyID, 'linked2project', '', $projectID);
        }        
    }

    /**
     * Unlink story. 
     * 
     * @param  int    $projectID 
     * @param  int    $storyID 
     * @access public
     * @return void
     */
    public function unlinkStory($projectID, $storyID)
    {
        $this->dao->delete()->from(TABLE_PROJECTSTORY)->where('project')->eq($projectID)->andWhere('story')->eq($storyID)->limit(1)->exec();
        $this->loadModel('story')->setStage($storyID);
        $this->loadModel('action')->create('story', $storyID, 'unlinkedfromproject', '', $projectID);
        $tasks = $this->dao->select('id')->from(TABLE_TASK)->where('story')->eq($storyID)->andWhere('project')->eq($projectID)->andWhere('status')->in('wait,doing')->fetchPairs('id');
        $this->dao->update(TABLE_TASK)->set('status')->eq('cancel')->where('id')->in($tasks)->exec();
        foreach($tasks as $taskID)
        {
            $changes  = $this->loadModel('task')->cancel($taskID);
            $actionID = $this->action->create('task', $taskID, 'Canceled');
            $this->action->logHistory($actionID, $changes);
        }
    }

    /**
     * Get team members. 
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function getTeamMembers($projectID)
    {
        return $this->dao->select('t1.*, t1.hours * t1.days AS totalHours, t2.realname')->from(TABLE_TEAM)->alias('t1')
            ->leftJoin(TABLE_USER)->alias('t2')->on('t1.account = t2.account')
            ->where('t1.project')->eq((int)$projectID)
            ->andWHere('t2.company')->eq($this->app->company->id)
            ->fetchAll('account');
    }

    /**
     * Get team members in pair.
     * 
     * @param  int    $projectID 
     * @param  string $params 
     * @access public
     * @return array
     */
    public function getTeamMemberPairs($projectID, $params = '')
    {
        $users = $this->dao->select('t1.account, t2.realname')->from(TABLE_TEAM)->alias('t1')
            ->leftJoin(TABLE_USER)->alias('t2')->on('t1.account = t2.account')
            ->where('t1.project')->eq((int)$projectID)
            ->andWHere('t2.company')->eq($this->app->company->id)
            ->beginIF($params == 'nodeleted')
            ->andWhere('t2.deleted')->eq(0)
            ->fi()
            ->fetchPairs();
        if(!$users) return array();
        foreach($users as $account => $realName)
        {
            $firstLetter = ucfirst(substr($account, 0, 1)) . ':';
            $users[$account] =  $firstLetter . ($realName ? $realName : $account);
        }
        return array('' => '') + $users;
    }

    /**
     * Manage team members.
     * 
     * @param  int    $projectID 
     * @access public
     * @return void
     */
    public function manageMembers($projectID)
    {
        extract($_POST);

        $accounts = array_unique($accounts);
        foreach($accounts as $key => $account)
        {
            if(empty($account)) continue;

            $member->role  = $roles[$key];
            $member->days  = $days[$key];
            $member->hours = $hours[$key];
            $mode        = $modes[$key];

            if($mode == 'update')
            {
                $this->dao->update(TABLE_TEAM)->data($member)->where('project')->eq((int)$projectID)->andWhere('account')->eq($account)->exec();
            }
            else
            {
                $member->project = (int)$projectID;
                $member->account = $account;
                $member->join    = helper::today();
                $this->dao->insert(TABLE_TEAM)->data($member)->exec();
            }
        }        
    }

    /**
     * Unlink a member.
     * 
     * @param  int    $projectID 
     * @param  string $account 
     * @access public
     * @return void
     */
    public function unlinkMember($projectID, $account)
    {
        $this->dao->delete()->from(TABLE_TEAM)->where('project')->eq((int)$projectID)->andWhere('account')->eq($account)->exec();
    }

    /**
     * Compute burn of a project.
     * 
     * @access public
     * @return array
     */
    public function computeBurn()
    {
        $today    = helper::today();
        $burns    = array();

        $projects = $this->dao->select('id, name')->from(WGC_TABLE_PROJECT)
            ->where("end >= '$today'")
            ->orWhere('end')->eq('0000-00-00')
            ->fetchPairs();
        if(!$projects) return $burns;
        foreach($projects as $key=>$value)
        {
           $revisioninfo = $this->dao->select('revision')->from(WGC_TABLE_SIGNOFF)->where('project')->eq($key)->orderBy('revision desc')->limit(1)->fetch();
           $revision = $revisioninfo->revision;
           $burnss[] = $this->dao->select("project, '$today' AS date, '$revision' AS revision, sum(`left`) AS `left`, SUM(consumed) AS `consumed`")
            ->from(WGC_TABLE_SIGNOFF)
            ->where('project')->in($key)
            ->andWhere('deleted')->eq('0')
            ->andWhere('revision')->eq($revisioninfo->revision)
            ->groupBy('project')
            ->fetchAll();
            unset($revisioninfo);
            unset($revision);
        }
        foreach($burnss as $value)
        {
           if(isset($value[0]))
           {
              $burnsss[] = $value[0];
           }
        }
        //print_r($burnsss);
        $burns = $this->dao->select("project, '$today' AS date, sum(`left`) AS `left`, SUM(consumed) AS `consumed`")
            ->from(WGC_TABLE_SIGNOFF)
            ->where('project')->in(array_keys($projects))
            ->andWhere('deleted')->eq('0')
            ->groupBy('project')
            ->fetchAll();
       //print_r($burns);
      
        foreach($burnsss as $Key => $burn)
        {
            $this->dao->replace(TABLE_BURN)->data($burn)->exec();
            $burn->projectName = $projects[$burn->project];
        }
        return $burnsss;
    }
   
    /**
     * Get data of burn down chart.
     * 
     * @param  int    $projectID 
     * @param  int    $itemCounts 
     * @access public
     * @return array
     */
    public function getBurnData($projectID = 0,$revision = 0 ,$itemCounts = 30)
    {
        /* Get project and burn counts. */
        $project    = $this->getById($projectID);
        $burnCounts = $this->dao->select('count(*) AS counts')->from(TABLE_BURN)->where('project')->eq($projectID)->andWhere('revision')->eq($revision)->fetch('counts');

        /* If the burnCounts > $itemCounts, get the latest $itemCounts records. */
        $sql = $this->dao->select('date AS name, `left` AS value')->from(TABLE_BURN)->where('project')->eq((int)$projectID)->andWhere('revision')->eq($revision);
        if($burnCounts > $itemCounts)
        {
            $sets = $sql->orderBy('date DESC')->limit($itemCounts)->fetchAll('name');
            $sets = array_reverse($sets);
        }
        else
        {
            /* The burnCounts < itemCounts, after getting from the db, padding left dates. */
            $sets    = $sql->orderBy('date ASC')->fetchAll('name');
            $current = helper::today();
/*            if($project->end != '0000-00-00')
            {
                $period = helper::diffDate($project->end, $project->begin) + 1;
                $counts = $period > $itemCounts ? $itemCounts : $period;
            }
            else
            {
                $counts = $itemCounts;
            }*/
            //add wgc
            if($project->days != 0)
            {
                
                $counts = intval($project->days);
            }
            else
            {
                $counts = $itemCounts;
            }
            
            
            for($i = 0; $i < $counts - $burnCounts; $i ++)
            {
                if(helper::diffDate($current, $project->end) > 0) break;
                
                if(!isset($sets[$current]))
                {
                    $sets[$current]->name = $current;
                    $sets[$current]->value = '';
                }
                $nextDay = date(DT_DATE1, strtotime('next day', strtotime($current)));
                $current = $nextDay;
            }
        }
        foreach($sets as $set) $set->name = substr($set->name, 5);
        return $sets;
    }

    public function getBurnDataFlot($projectID = 0, $itemCounts = 30)
    {
    	/* get max revision  */
    	$maxrevision = $this->loadModel('dept')->getMaxrevision($projectID);
        /* Get project and burn counts. */
        $project    = $this->getById($projectID);
        $burnCounts = $this->dao->select('count(*) AS counts')->from(TABLE_BURN)->where('project')->eq($projectID)->andWhere('revision')->eq($maxrevision)->fetch('counts');

        /* If the burnCounts > $itemCounts, get the latest $itemCounts records. */
        $sql = $this->dao->select('date AS name, `left` AS value')->from(TABLE_BURN)->where('project')->eq((int)$projectID)->andWhere('revision')->eq($maxrevision);
        if($burnCounts > $itemCounts)
        {
            $sets = $sql->orderBy('date DESC')->limit($itemCounts)->fetchAll('name');
            $sets = array_reverse($sets);
        }
        else
        {
            /* The burnCounts < itemCounts, after getting from the db, padding left dates. */
            $sets    = $sql->orderBy('date ASC')->fetchAll('name');
            $current = helper::today();
            if($project->end != '0000-00-00')
            {
                $period = helper::diffDate($project->end, $project->begin) + 1;
                $counts = $period > $itemCounts ? $itemCounts : $period;
            }
            else
            {
                $counts = $itemCounts;
            }

            for($i = 0; $i < $counts - $burnCounts; $i ++)
            {
                if(helper::diffDate($current, $project->end) > 0) break;
                if(!isset($sets[$current]))
                {
                    $sets[$current]->name = $current;
                    $sets[$current]->value = '';
                }
                $nextDay = date(DT_DATE1, strtotime('next day', strtotime($current)));
                $current = $nextDay;
            }
        }
        $count = 0;
        foreach($sets as $set) 
        {
            $set->name = (string)strtotime("$set->name UTC") . '000';
            $count ++;
        }
        $sets['count'] = $count;
        return $sets;
    }

    /**
     * Get taskes by search.
     * 
     * @param  string $condition 
     * @param  object $pager 
     * @param  string $orderBy 
     * @access public
     * @return array
     */
    public function getSearchTasks($condition, $pager, $orderBy)
    {
		$account = $this->app->user->account;
        if(strpos(",admin,issac,lynn,", $this->app->user->account) !== false || ($this->app->user->dept == 14) && $this->app->user->address  == "CN")
        {
    	$taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
		
        }
        elseif(strpos(",torch,", $this->app->user->account) !== false)
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('region')->like('%china')
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
        }
        elseif(strpos(",michael,", $this->app->user->account) !== false || ( $this->app->user->dept == 14 && $this->app->user->address == 'SCN' ))
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('region')->eq('southchina')
            //->andWhere('openby')->notin(explode(',',$this->lang->project->chenwei))
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
        }
        elseif( $this->app->user->account == "davidtimm" || ( $this->app->user->dept == 14 && $this->app->user->address == 'US' ) || $account == "andywang" || $account == 'paulliu')
        {
        	$condition = str_replace("`id`",'a.id',$condition);
            $taskIdList = $this->dao->select('a.*')
            ->from(WGC_TABLE_CUSTOM)->alias('a')
			->leftjoin('zt_wgclowprice')->alias('b')
		    ->on('a.partnumber = b.partnumber')
            ->where($condition)
			//->beginIF($account == 'andywang')->andWhere('region')->in(array('southchina','northchina','taiwan','korea','japan','asia'))->fi()
			->beginIF($account == 'davidtimm')->orWhere('a.distributor')->eq('D00059')->fi()			
            //->andWhere('a.endapp')->eq('Q')
			->andWhere(' ( b.partnumber')->like('71m%')
			->orWhere('b.projectname')->eq('maxin')
			->markright(1)
			->beginIF($account == 'davidtimm')->orWhere('a.region')->in(array('japan','india'))->fi()
			->andWhere('a.deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
			
        }
        elseif(strpos(",henry,", $this->app->user->account) !== false)
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('region')->eq('northchina')
            //->andWhere('openby')->in(explode(',',$this->lang->project->chenwei))
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
           
        }                 
        elseif(strpos(",dennis,nick,tim,jackyan,jessie", $this->app->user->account) !== false || ( $this->app->user->dept == 14 && $this->app->user->address == 'TW' ))
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere(' ( region')->eq('taiwan')
            ->andWhere('deleted')->eq(0)
			->orWhere('distributor')->in('D00066,D00040')
			->markright(1)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
        }
		elseif(strpos(",winston,xuanhong,lynn_wang,", $this->app->user->account) !== false)
		{
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('partnumber')->like('SSL%')
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();		
		}
        elseif(strpos(",frankie,harvey,josh,", $this->app->user->account) !== false)
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
			->andWhere('deleted')->eq(0)
            ->andWhere('( fae')->like($this->app->user->account."%")
            ->orWhere('sales')->like($this->app->user->account."%")
			->orWhere('region')->eq('strategy')
			->orWhere("end_customer")->in(array('C001811','C001065','C000415','C001462','C000593','C001358','C000970','C001524','C000723','C000014','C000537','C001618','C000229','C000506'))
            ->markright(1)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
        }
        elseif(strpos(",regina,", $this->app->user->account) !== false)
        {
          
			$condition = str_replace('`partnumber`','t1.partnumber',$condition);
			//$condition = str_replace('t1.partnumber','t1.partnumber',$condition);
			$condition = str_replace('id','t1.id',$condition);
			$condition = str_replace('status','t1.status',$condition);$condition = str_replace('rfqcode','t1.rfqcode',$condition);
			$condition = str_replace('end_customer','t1.end_customer',$condition);$condition = str_replace('distributor','t1.distributor',$condition);
			$condition = str_replace('price_dis','t1.price_dis',$condition);$condition = str_replace('price_cus','t1.price_cus',$condition);
			$condition = str_replace('commission','t1.commission',$condition);$condition = str_replace('openby','t1.openby',$condition);
			$condition = str_replace('date','t1.date',$condition);
            $taskIdList = $this->dao->select('t1.*')
            ->from(WGC_TABLE_CUSTOM)->alias('t1')
			->leftjoin('zt_wgclowprice')->alias('t2')
			->on('t1.partnumber = t2.partnumber')
            ->where($condition)
			->andWhere('t1.deleted')->eq(0)
            ->andWhere('( t1.fae')->like($this->app->user->account."%")
            ->orWhere('t1.sales')->like($this->app->user->account."%")
			->orWhere('t2.prolines')->eq('LED Lighting')
            ->orWhere('t1.openby')->eq('regina')
            ->markright(1)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
			
        }
        elseif(strpos(",joshuah,", $this->app->user->account) !== false && $this->app->user->account != "josh")
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('region')->eq('korea')
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
        }
        elseif($this->app->user->account == "josh")
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)
            ->where($condition)
            ->andWhere('openby')->eq('josh')
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
			
        }
        elseif($this->app->user->dept == 19)
        {
            $condition = str_replace("`id`","a.id",$condition);
			$condition = str_replace("`partnumber`","a.partnumber",$condition);
            $taskIdList = $this->dao->select('a.*')
            ->from(WGC_TABLE_CUSTOM)->alias('a')
            ->leftjoin('zt_wgclowprice')->alias('b')
            ->on('a.partnumber = b.partnumber')
            ->where($condition)
            ->andWhere('b.promanager')->like('%'.$this->app->user->account.'%')
            ->andWhere('a.deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
			
        }
        else 
        {
            $taskIdList = $this->dao->select('*')
            ->from(WGC_TABLE_CUSTOM)->alias('a')
            ->leftjoin('zt_wgcend')->alias('b')
            ->on('a.end_customer = b.cardcode')
            ->where($condition)
            ->andWhere('( b.fae')->eq($this->app->user->account)
            ->orWhere('b.sales')->eq($this->app->user->account)
            ->orWhere('a.openby')->eq($this->app->user->account)
            ->markright(1)
            ->andWhere('a.deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
			
        	
        }
		
/*        foreach($taskIdList as $key => $value)
        {
        	if(!$this->checkPriv($value))
        	{
        	   unset($taskIdList[$key]);
        	}
        }*/
        $sql = explode('WHERE', $this->dao->get());
        $sql = explode('ORDER', $sql[1]);
		
        $this->session->set('projectCondition222', $sql[0]);
		
		
		//echo $this->session->projectCondition2;
        return $taskIdList;
    }

    /**
     * Get bugs by search in project. 
     * 
     * @param  int    $products 
     * @param  int    $projectID 
     * @param  int    $sql 
     * @param  int    $pager 
     * @param  int    $orderBy 
     * @access public
     * @return void
     */
    public function getSearchBugs($products, $projectID, $sql, $pager, $orderBy)
    {
        return $this->dao->select('*')->from(TABLE_BUG)
            ->where($sql)
            ->andWhere('status')->eq('active')
            ->andWhere('toTask')->eq(0)
            ->andWhere('tostory')->eq(0)
            ->beginIF(!empty($products))->andWhere('product')->in(array_keys($products))->fi()
            ->beginIF(empty($products))->andWhere('project')->eq($projectID)->fi()
            ->andWhere('deleted')->eq(0)
            ->orderBy($orderBy)
            ->page($pager)
            ->fetchAll();
    }

    /**
     * Get resolved bugs of a project
     * 
     * @param  int    $projectID 
     * @access public
     * @return array
     */
    public function getResolvedBugs($projectID)
    {
        $project  = $this->getById($projectID);
        $products = $this->dao->select('product')->from(TABLE_PROJECTPRODUCT)->where('project')->eq($projectID)->fetchPairs('product');
        return $this->dao->select('id, title, status')->from(TABLE_BUG)
            ->where('status')->eq('resolved')
            ->andWhere('resolvedDate')->ge($project->begin)
            ->andWhere('resolution')->eq('fixed')
            ->andWhere('product')->in($products)
            ->fetchAll();
    }
    
    /* check account pri is self or admin
     * @param int $projectID
     * @param str $account
     * @access public
     * @return str
     */ 
    public function checkAccountPri($projectID,$account)
    {
       $loginer = $this->app->user->account;
       if(strpos($this->app->company->admins, $loginer) !== false) return true;
       if($this->checkAdminGroup()) return true;
       if($loginer == trim($account)) return true;
       echo js::error('Can not review the item  !');
       die(js::locate('back')); 
    }
    
    /*
     * get parent project select html
     */
    public function dafenglei_select($m,$id,$index)
    {
       $str = "";
	   $class_arrobject = $this->dao->select('id,`name`,`parent`,`order`')->from(WGC_TABLE_PRODUCT)->orderby('`order` asc,id asc')->fetchAll();
	   if(!$class_arrobject) echo '';
	   foreach($class_arrobject as $value)
	   {
	   	$class_arr[] = array($value->id,$value->name,$value->parent,$value->order);
	   }
	   
       $n = str_pad('',$m,'-',STR_PAD_RIGHT);
	   $n = str_replace("-","&nbsp;&nbsp;",$n);
	  
	   for($i=0;$i<count($class_arr);$i++)
	   {

		   if($class_arr[$i][2]==$id)
		   {
			   if($class_arr[$i][0]==$index)
			   {
				   $str .=  "        <option value=\"".$class_arr[$i][0]."\" selected=\"selected\">".$n."|--".$class_arr[$i][1]."</option>\n";
			   }
			   else
			   {
				   $str .=  "        <option value=\"".$class_arr[$i][0]."\">".$n."|--".$class_arr[$i][1]."</option>\n";
			   }
			   $str .= $this->dafenglei_select($m+1,$class_arr[$i][0],$index);

		   }

	   }
	   
	   return $str;

   } 


   public function sendApproveMail($region='china',$mailname = 'admin')
   {

   	   $toList      = $mailname;
       $subject     = date("Y-m-d")." Request For Quotation list ";
       $ccList      = "admin";
	   $datestr = date("Y-m-d",(mktime()-24*3600*10));
	   if(strpos($mailname,'issac') !== false || strpos($mailname,'wugaochao') !== false || strpos($mailname,'shuangjuan') !== false || strpos($mailname,'lynn') !== false || strpos($mailname,'admin') !== false)
	   {
    	   $result = $this->dao->select('a.*,b.role,b.signature,b.signdate')->from('zt_custom')->alias('a')
			     ->leftJoin('zt_approve')->alias('b')
    	         ->on('a.id = b.cid')
		         ->where('a.status')->in(array('Pending'))
                 ->andWhere('a.id')->ge('4800')
			     ->andWhere('b.role')->eq('1')
			     ->andWhere('b.signature')->eq('approve')
				 ->andWhere('b.signdate')->ge('2014-12-30')
                 ->fetchAll();
		   
	   }
	   elseif(strpos($mailname,'michael') !== false || strpos($mailname,'henry') !== false)
	   {
	   	   $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
	   	   ->where('`createdate`')->gt($datestr)
	   	   ->andWhere('status')->eq("Pending")
	   	   ->andWhere('region')->eq($region)
	   	   ->andWhere('openby')->notin(explode(',',$this->lang->project->chenwei))
	   	   ->fetchAll();
	   }
	   
   	   elseif(strpos($mailname,'nick') !== false)
	   {
	   	   $this->loadModel('forecast');
	   	   $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
	   	   ->where('`createdate`')->gt($datestr)
	   	   ->andWhere('status')->eq("Pending")
	   	   ->andWhere("end_customer")->notin(explode(',',str_replace("'","",$this->config->forecast->SB)))
	   	   ->andWhere('region')->eq("taiwan")
	   	   ->fetchAll();
	   }
      elseif(strpos($mailname,'frankie') !== false)
	   {
	   	   $this->loadModel('forecast');
	   	   $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
	   	   ->where('`createdate`')->gt($datestr)
	   	   ->andWhere('status')->eq("Pending")
	   	   ->andWhere(" ( end_customer")->in(explode(',',str_replace("'","",$this->config->forecast->SB)))
	   	   ->orWhere('region')->eq("strategy")
		   ->markright(1)
	   	   ->fetchAll();
	   }
      elseif(strpos($mailname,'harvey') !== false)
	   {
	   	   $this->loadModel('forecast');
	   	   $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
	   	   ->where('`createdate`')->gt($datestr)
	   	   ->andWhere('status')->eq("Pending")
	   	   ->andWhere(" ( end_customer")->in('C001811','C000970')
	   	   ->orWhere('region')->eq("strategy")
		   ->markright(1)
	   	   ->fetchAll();
	   }
	   elseif(strpos($mailname,'davidtimm') !== false )
	   {
		   $datestr = date("Y-m-d",(mktime()-24*3600*30));
	   	   $result = $this->dao->select('a.*')->from(WGC_TABLE_CUSTOM)->alias('a')
		   ->leftjoin('zt_wgclowprice')->alias('b')
		   ->on('a.partnumber = b.partnumber')
	   	   ->where('a.createdate')->gt($datestr)
	   	   ->andWhere('a.status')->eq("Pending")
	   	   ->andWhere('a.region')->in('europe,us,japan,india,asean')
		   ->andWhere('( a.partnumber')->like('71m%')
		   ->orWhere('b.projectname')->eq('maxin')
		   ->markright(1)
	   	   ->fetchAll();
	   }
	   else
	   {
	   
          $result = $this->dao->select('*')->from(WGC_TABLE_CUSTOM)
                 ->where('`createdate`')->gt($datestr)
                 ->andWhere('status')->eq("Pending")
                 ->beginIF($region != "*")->andWhere('region')->like($region)->fi()
                 ->fetchAll();	   
	   }
   	   if(strpos($mailname,'issac') !== false || strpos($mailname,'wugaochao') !== false)
	   {
		   
    	   $resultissac = $this->dao->select('a.*,b.role,b.signature,b.signdate')->from('zt_custom')->alias('a')
			     ->leftJoin('zt_approve')->alias('b')
    	         ->on('a.id = b.cid')
			     ->leftjoin('zt_wgclowprice')->alias('c')
			     ->on('a.partnumber = c.partnumber')
		         ->where('a.status')->eq('Pending')
                 ->andWhere('a.id')->ge('4800')
			     ->andWhere('b.role')->eq('0')
			     ->andWhere('b.signature')->eq('approve')
				 ->andWhere('b.signdate')->ge('2014-12-30')
			   	 ->andWhere(' ( c.promanager')->eq('')
			     ->orWhere('c.promanager is null')
			     ->markright(1)
                 ->fetchAll();
		  
	   }	
	   
       if(count($result) < 1 && strpos($mailname,'issac') === false) return false;
       if(count($result) < 1 && count($resultissac) < 1 && strpos($mailname,'issac') !== false) return false;
	   
       $str .= "<style> table {font-size:11px;} .fuck tr td {border:1px solid #ccc;}</style>";
       $str .= "Hi ".$mailname ."<br/>"." &nbsp;&nbsp;&nbsp;".date("Y.m.d")." of ".$region." Request for Quotation as follows :";
       $str .= "&nbsp;&nbsp;&nbsp;<table class='fuck' width='1360' style='border:1px solid #CCC;border-collapse:collapse'><tr class='colhead' style='background:#ccc'><th class='w-id'>ID</th><th width='120'>RFQ#</th><th width='80'>Part Number</th><th width='100'>End Customer</th><th width='100'>Distributor</th><th width='60'>Resell Price</th><th width='60'>Dist. Price</th><th width='80' style='color:#ff0000;width:100px;'>Mgr Approve Dis. Price </th><th width='80' style='color:#ff0000;width:100px;'>PM Price </th><th>Usuage(kpcs)</th><th width='80'>Commission</th><th width='80'>Request by</th><th width='80'>Date</th><th width='60'>Valid Date</th><th width='60'>Old RFQ/Cost Down</th><th width='80'>Sales</th> <th width='60'>End APP.</th><th width='60'>Region</th><th width='80'>Status</th><th width='120'>Reason</th>";
       $j = 1;
       foreach($result as $value)
       {
              if($value->oldrfq)
              {
                 $oldprice = $this->getById($value->oldrfq);
                 if($oldprice->price_cus)
                 {
					$costdown = number_format(($oldprice->price_dis - $value->price_dis)/$oldprice->price_dis,'3','.','')*100;
                    $oldinfo = $oldprice->price_dis."(".$oldprice->price_cus.")"."(".$costdown."%)";
                 }
                 else
                 {
                    $oldinfo = $oldprice->price_dis;
                 
                 }  
              } 
		  $tmpendname = $this->dao->select('cardname')->from('zt_wgcend')->where('cardcode')->eq($value->end_customer)->fetch();
          $value->end_cus_code = $value->end_customer."-".$tmpendname->cardname;
		  $tmpdiscode = $this->dao->select('cardname')->from('zt_wgcdis')->where('cardcode')->eq($value->distributor)->fetch();
		  $value->discode = $value->distributor."-".$tmpdiscode->cardname;
          $tmpmgrprice = $this->dao->select('price')->from('zt_approve')->where('cid')->eq(intval($value->id))->andWhere('role')->eq('0')->fetch(); 
          $value->mgrprice = $tmpmgrprice->price;   
          $tmppmprice = $this->dao->select('price')->from('zt_approve')->where('cid')->eq(intval($value->id))->andWhere('role')->eq('1')->fetch(); 
          $value->pmprice = $tmppmprice->price; 		  
       	  if($j % 2 == 0)
       	  {
       	  	 $str .= "<tr style='background:#A6F0FD;'>";
       	  }
       	  else 
       	  {
       	     $str .= "<tr>";
       	  }
          $str .= "<td>$value->id</td><td>$value->rfqcode</td><td>$value->partnumber</td><td>".str_replace(' ','',$value->end_cus_code)."</td><td>".$value->discode."</td><td>$value->price_cus</td><td>$value->price_dis</td><td>$value->mgrprice</td><td>$value->pmprice</td><td>$value->usage</td>";
          $str .= "<td>$value->commission</td><td>$value->openby</td><td>$value->date</td><td>$value->validperiod</td><td style='color:red'>$oldinfo</td><td>$value->sales</td><td>$value->endapp</td><td>$value->region</td><td>$value->status</td><td>".htmlspecialchars($value->reason)."</td>";
          $str .= "</tr>";
          unset($oldinfo);
          $j++;
       }
       $h = $j;
       //issac china region
       foreach($resultissac as $value)
       {

              if($value->oldrfq)
              {
                 $oldprice = $this->getById($value->oldrfq);
                 if($oldprice->price_cus)
                 {
                    //$oldinfo = $oldprice->price_dis."($oldprice->price_cus)";
					$costdown = number_format(($oldprice->price_dis - $value->price_dis)/$oldprice->price_dis,'3','.','')*100;
                    $oldinfo = $oldprice->price_dis."(".$oldprice->price_cus.")"."(".$costdown."%)";
                 }
                 else
                 {
                    $oldinfo = $oldprice->price_dis;
                 
                 }  
              } 
          $tmpmgrprice = $this->dao->select('price')->from('zt_approve')->where('cid')->eq(intval($value->id))->andWhere('role')->eq('0')->fetch(); 
          $value->mgrprice = $tmpmgrprice->price;  
		  $tmpdiscode = $this->dao->select('cardname')->from('zt_wgcdis')->where('cardcode')->eq($value->distributor)->fetch();
		  $value->discode = $value->distributor."-".$tmpdiscode->cardname;
       	  if($h % 2 == 0)
       	  {
       	  	 $str .= "<tr style='background:#A6F0FD;'>";
       	  }
       	  else 
       	  {
       	     $str .= "<tr>";
       	  }
		  $tmpendname = $this->dao->select('cardname')->from('zt_wgcend')->where('cardcode')->eq($value->end_customer)->fetch();
          $value->end_cus_code = $value->end_customer."-".$tmpendname->cardname;
          $str .= "<td>$value->id</td><td>$value->rfqcode</td><td>$value->partnumber</td><td>".str_replace(' ','',$value->end_cus_code)."</td><td>$value->discode</td><td>$value->price_cus</td><td>$value->price_dis</td><td>$value->mgrprice</td><td>$value->pmprice</td><td>$value->usage</td>";
          $str .= "<td>$value->commission</td><td>$value->openby</td><td>$value->date</td><td>$value->validperiod</td><td style='color:red'>$oldinfo</td><td>$value->sales</td><td>$value->endapp</td><td>$value->region</td><td>$value->status</td><td>".htmlspecialchars($value->reason)."</td>";
          $str .= "</tr>";
          unset($oldinfo);
          $h++;
              
       }
       
       $str .= "</table>";
	  
	   //header("Content-type:text/html;charset=utf-8");
	   //echo $str;exit;
   	   $this->loadModel('mail')->send($toList,$subject , $str, '');
   	   
       
   
   	   
       
   }

  public function sendApprovePmMail($mailname)
  {

		   
   	   $toList      = $mailname;
       $subject     = date("Y-m-d")." Request For Quotation list ,Please approve it in system.";
       $ccList      = "admin";
	   $datestr = date("Y-m-d",(mktime()-24*3600*30));

	   $result0 = $this->dao->select('a.*')->from(WGC_TABLE_CUSTOM)->alias('a')
		   ->leftjoin('zt_approve')->alias('b')
		   ->on('a.id = b.cid')
		   ->leftjoin('zt_wgclowprice')->alias('c')
		   ->on('a.partnumber = c.partnumber')
	   	   ->where('a.createdate')->gt($datestr)
	   	   ->andWhere('a.status')->eq("Pending")
	   	   ->andWhere('b.role')->eq('0')
		   ->andWhere('b.signature')->eq('approve')
		   ->andWhere('c.promanager')->like('%'.$mailname.'%')
		   ->beginIF($mailname == "andywang")->andWhere('region')->notin(array('europe','us'))->fi()
           ->beginIF($mailname == "paulliu")->andWhere('region')->in(array('europe','us'))->fi()
	   	   ->fetchAll();
	  
	   foreach($result0 as $key0 => $value0)
	   {
	      $rolepm = $this->dao->select('id')->from('zt_approve')->where('cid')->eq($value0->id)->andWhere('role')->eq('1')->andWhere('signature')->eq('approve')->fetch();
		  if($rolepm->id > 0)
		   {
		  
		   }
		   else
		   {
		      $result[$key0] = $value0;
		   }
	   }

       if(count($result) < 1) return false;
	   
       $str .= "<style> table {font-size:11px;} .fuck tr td {border:1px solid #ccc;}</style>";
       $str .= "Hi ".$mailname ."<br/>"." &nbsp;&nbsp;&nbsp;".date("Y.m.d")." of ".$region." Request for Quotation as follows,please approve it as PM role :";
       $str .= "&nbsp;&nbsp;&nbsp;<table class='fuck' width='1360' style='border:1px solid #CCC;border-collapse:collapse'><tr class='colhead' style='background:#ccc'><th class='w-id'>ID</th><th width='120'>RFQ#</th><th width='80'>Part Number</th><th width='100'>End Customer</th><th width='100'>Distributor</th><th width='60'>Resell Price</th><th width='60'>Dist. Price</th><th width='80'>CM Approve Dis. Price </th><th width='80' style='color:#ff0000;width:100px;'>PM Approve Dis. Price </th><th>Usuage(kpcs)</th><th width='80'>Commission</th><th width='80'>Request by</th><th width='80'>Date</th><th width='60'>Valid Date</th><th width='60'>Old RFQ/Cost Down</th><th width='80'>Sales</th> <th width='60'>End APP.</th><th width='60'>Region</th><th width='80'>Status</th><th width='120'>Reason</th>";
       $j = 1;
       foreach($result as $value)
       {

              if($value->oldrfq)
              {
                 $oldprice = $this->getById($value->oldrfq);
                 if($oldprice->price_cus)
                 {
					$costdown = number_format(($oldprice->price_dis - $value->price_dis)/$oldprice->price_dis,'3','.','')*100;
                    $oldinfo = $oldprice->price_dis."(".$oldprice->price_cus.")"."(".$costdown."%)";
                 }
                 else
                 {
                    $oldinfo = $oldprice->price_dis;
                 
                 }  
              } 
		  $tmpendname = $this->dao->select('cardname')->from('zt_wgcend')->where('cardcode')->eq($value->end_customer)->fetch();
          $value->end_cus_code = $value->end_customer."-".$tmpendname->cardname;
		  $tmpdiscode = $this->dao->select('cardname')->from('zt_wgcdis')->where('cardcode')->eq($value->distributor)->fetch();
		  $value->discode = $value->distributor."-".$tmpdiscode->cardname;
          $tmpmgrprice = $this->dao->select('price')->from('zt_approve')->where('cid')->eq(intval($value->id))->andWhere('role')->eq('0')->fetch(); 
          $value->mgrprice = $tmpmgrprice->price;      	
       	  if($j % 2 == 0)
       	  {
       	  	 $str .= "<tr style='background:#A6F0FD;'>";
       	  }
       	  else 
       	  {
       	     $str .= "<tr>";
       	  }
          $str .= "<td>$value->id</td><td>$value->rfqcode</td><td>$value->partnumber</td><td>".str_replace(' ','',$value->end_cus_code)."</td><td>".$value->discode."</td><td>$value->price_cus</td><td>$value->price_dis</td><td>$value->mgrprice</td><td></td><td>$value->usage</td>";
          $str .= "<td>$value->commission</td><td>$value->openby</td><td>$value->date</td><td>$value->validperiod</td><td style='color:red'>$oldinfo</td><td>$value->sales</td><td>$value->endapp</td><td>$value->region</td><td>$value->status</td><td>".htmlspecialchars($value->reason)."</td>";
          $str .= "</tr>";
          unset($oldinfo);
          $j++;
       }
       $h = $j;
       
       $str .= "</table>";

   	   $this->loadModel('mail')->send($toList,$subject , $str,'');     
  
  }


   public function sendMailToSales()
   {

      $sales = $this->dao->select('account,dept')->from(TABLE_USER)->where('dept')->in('1,13')->andWhere('account')->ne('issac')->fetchAll();
    
      $datestr = date("Y-m-d",(mktime()-24*3600*1));
      foreach($sales as $valueu)
      {
         $result = $this->dao->select('a.*')->from(WGC_TABLE_CUSTOM)->alias('a')
                   ->leftJoin(TABLE_ACTION)->alias('b')
                   ->on('a.id = b.objectID')
                   ->where('a.openby')->eq($valueu->account)
                   ->andWhere('b.date')->ge($datestr)
			       ->andWhere('b.objecttype')->eq('wgcproject')
                   ->andWhere('b.action')->in(array('edited','updated'))
                   ->groupBy('a.id')
                   ->fetchAll();
         //echo $this->dao->get();  exit;   
         if(count($result) > 0) 
         {
         $toList      = $valueu->account;
         $ccList      = "software@silergycorp.com";
         $subject     = date("Y-m-d")." Request For Quotation result list ";
         $ccList      = "";
         $str .= "<style> table {font-size:11px;} .fuck tr td {border:1px solid #ccc;}</style>";
         $str .= "Hi ".$toList ."<br/>"." &nbsp;&nbsp;&nbsp;".date("Y.m.d")." Request for Quotation feedback as follows :";
         $str .= "&nbsp;&nbsp;&nbsp;<table class='fuck' width='1360' style='border:1px solid #CCC;border-collapse:collapse'><tr class='colhead' style='background:#ccc'><th class='w-id'>ID</th><th class='w-120px'>RFQ#</th><th class='w-80px'>Part Number</th><th class='w-100px'>End Customer</th><th class='w-100px'>Distributor</th><th class='w-60px'>Resell Price</th><th class='w-60px'>Dist. Price</th><th class='w-80px'>Commission</th><th class='w-80px'>Request by</th><th class='w-80px'>Date</th><th class='w-60px'>Valid Date</th><th class='w-60px'>Old RFQ</th><th class='w-80px'>Sales</th> <th class='w-60px'>End APP.</th><th class='w-60px'>Region</th><th class='w-80px'>Status</th>";    
         foreach($result as $value)
         {
              if($value->oldrfq)
              {
                 $oldprice = $this->getById($value->oldrfq);
                 if($oldprice->price_cus)
                 {
                    $oldinfo = $oldprice->price_dis."($oldprice->price_cus)";
                 }
                 else
                 {
                    $oldinfo = $oldprice->price_dis;
                 
                 }  
              }

             $disprieschange = $this->dao->select('b.old,b.new')->from('zt_action')->alias('a')  
                               ->leftjoin('zt_history')->alias('b')
                               ->on('a.id = b.action')  
                               ->where('b.field')->eq('price_dis')
                               ->andWhere('a.objectid')->eq("1971")
                               ->andWhere('a.action')->in(array('edited','updated'))
                               ->andWhere('a.actor')->in(array('issac','admin'))
                               ->fetch();
             if($disprieschange->old > 0 && $$disprieschange->new >0) 
             {
                $str .= "<tr style='background:#FF0000;'>";
                $dispricestr = "(".$disprieschange->old.")";
             }
             else 
             {
                $str .= "<tr>";
                $dispricestr = "";
             }                       	 
       	     $tmpdiscode = $this->dao->select('cardname')->from('zt_wgcdis')->where('cardcode')->eq($value->distributor)->fetch();
			 $value->discode = $value->distributor."-".$tmpdiscode->cardname;
			 $tmpendname = $this->dao->select('cardname')->from('zt_wgcend')->where('cardcode')->eq($value->end_customer)->fetch();
             $value->end_cus_code = $value->end_customer."-".$tmpendname->cardname;
             $str .= "<td>$value->id</td><td>$value->rfqcode</td><td>$value->partnumber</td><td>$value->end_cus_code</td><td>$value->discode</td><td>$value->price_cus</td><td>".$value->price_dis." $dispricestr </td>";
             $str .= "<td>$value->commission</td><td>$value->openby</td><td>$value->date</td><td>$value->validperiod</td><td>$oldinfo</td><td>$value->sales</td><td>$value->endapp</td><td>$value->region</td><td>$value->status</td>";
             $str .= "</tr>";
             unset($oldinfo);
         }
         $str .= "</table>";

         $this->loadModel('mail')->send($toList,$subject , $str, $ccList);
         unset($str);
         }
      }
              
   
              
   }

  /*
   * get old rfq cost down
   * @param int oldrfq
   * @access public
   * @return numberic
   */ 
   public function getoldcostdown($oldrfq,$disprice)
   {
   	$result = $this->dao->select('price_dis')
   	->from(WGC_TABLE_CUSTOM)
   	->where('id')->eq(intval($oldrfq))
   	->fetch();
   	$ratenum = (1 - number_format($disprice/$result->price_dis,'3','.',''))*100;
   	return $ratenum;
   }
   
   
   /*
    * get old rfq by user or sales
    * @param string $user
    * @access public
    * @return object 
    */ 
   public function getOldRfq($user,$part = "",$dis = "",$end = "")
   {
      $result = $this->dao->select('id,rfqcode,discode,end_cus_code,partnumber,distributor,end_customer')
                ->from(WGC_TABLE_CUSTOM)
                //->where('openby')->eq($user)
                ->where('end_customer')->eq($end)
                ->andWhere('partnumber')->eq($part)
                ->andWhere('status')->eq("Approved")
                ->andWhere('deleted')->eq(0)
                ->orderBy('id desc')
                ->limit('0,1')
                ->fetch();
     return $result->id;
/*     $arr[0] = "No Old RFQ  ";
     if($result)
     {
     	
        foreach($result as $value)
        {
           $arr[$value->id] = $value->id."+".$value->rfqcode."+".$value->partnumber."+".$value->distributor."+".$value->end_customer;
        }
     }
     return $arr;*/
   }
   
   /*
    * get end and distributor info
    */
   public function getDistributorArr()
   {
      $vpartner = $this->dao->select('cardcode,cardname,cardfname')->from(WGC_TABLE_DIS)->where('cardcode')->notlike('V%')->andWhere('validfor')->eq('N')->orderBy('cardcode')->fetchAll();
      foreach($vpartner as $value)
      {
         $arr[$value->cardcode] = $value->cardcode." - ".str_replace('"','',$value->cardname)." - ".str_replace('"','',$value->cardfname);
      	 if($this->app->getViewType()=='mhtml'){$arr[$value->cardcode] = mb_substr($value->cardcode."-".str_replace('"','',$value->cardname),0,13,"UTF-8");}
      }
      
      return $arr;
   }

	public function getDistributorArrsample()
   {
      $vpartner = $this->dao->select('cardcode,cardname')->from(WGC_TABLE_DIS)->where('cardcode')->notlike('V%')->andWhere('validfor')->eq('N')->orderBy('cardcode')->fetchAll();
	  $arr[""]="";
      foreach($vpartner as $value)
      {
         $arr[$value->cardcode."-".str_replace('"','',$value->cardname)] = $value->cardcode."-".str_replace('"','',$value->cardname);
      	 if($this->app->getViewType()=='mhtml'){$arr[$value->cardcode] = mb_substr($value->cardcode."-".str_replace('"','',$value->cardname),0,13,"UTF-8");}
      }
      
      return $arr;
   }
   /*
    * get end and end customer info
    */
   public function getEndcustomerArr()
   {
   	  

      $vpartner = $this->dao->select('cardcode,cardname,cardfname,ucagent')->from('zt_wgcend')->orderBy('cardcode desc')->fetchAll();
      foreach($vpartner as $value)
      {
      	 if(iconv('gbk','UTF-8',$value->ucagent) != "" ) 
		 {
		    //$disname = " - distributor:" . $value->ucagent;
			$disname = "" ;
		 }
		 if(iconv('gbk','UTF-8',$value->cardfname) != "" ) 
		 {
		    $cardfname = " - " . $value->cardfname;
		 }
		 else 
		 {
		    $cardfname = "";
		 }
         $arr[$value->cardcode] = $value->cardcode ." - ". $value->cardname." ".$cardfname.$disname;
      	if($this->app->getViewType()=='mhtml')
        {
        	$arr[$value->cardcode] = mb_substr($value->cardcode ." - ". $value->cardname." ".$cardfname.$disname,0,16,"UTF-8");
        }
		
      }
      
      return $arr;
   
   }
   
   /*
    * check partnumber exist
    * @param string $partnumber
    */
   public function existPartnumber($partnumber)
   {
      
   	  $result = $this->dao->select('partnumber')->from(WGC_TABLE_LOWPRICE)->where('partnumber')->eq($partnumber)->fetch();
   	  if(!isset($result->partnumber)) echo js::error('Part number does not exist!');
   }

   
}
